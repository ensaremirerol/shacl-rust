name: Publish to crates.io

on:
    push:
        branches:
            - main
        tags:
            - 'shacl-rust-v*'
            - 'shacl-cli-v*'
            - 'shacl-mcp-v*'
            - 'shacl-wasm-v*'

permissions:
    contents: write

jobs:
    publish:
        runs-on: ubuntu-latest
        # Only run if this is a tag push or if the commit message contains version bumps
        if: startsWith(github.ref, 'refs/tags/') || contains(github.event.head_commit.message, 'chore: release main')
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Rust
              uses: actions-rust-lang/setup-rust-toolchain@v1
              with:
                  toolchain: stable

            - name: Publish shacl-rust (main crate)
              run: |
                  cargo publish --package shacl-rust --token ${{ secrets.CARGO_REGISTRY_TOKEN }} || echo "Already published or failed"

            # Wait for crates.io index to update
            - name: Wait for crates.io index update
              run: sleep 45

            - name: Publish shacl-cli
              run: cargo publish --package shacl-cli --token ${{ secrets.CARGO_REGISTRY_TOKEN }} || echo "Already published or failed"

            - name: Publish shacl-mcp
              run: cargo publish --package shacl-mcp --token ${{ secrets.CARGO_REGISTRY_TOKEN }} || echo "Already published or failed"

            - name: Publish shacl-wasm
              run: cargo publish --package shacl-wasm --token ${{ secrets.CARGO_REGISTRY_TOKEN }} || echo "Already published or failed"
