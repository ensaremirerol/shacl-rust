name: Release Please

on:
    push:
        branches:
            - main

permissions:
    contents: write
    pull-requests: write

jobs:
    release-please:
        runs-on: ubuntu-latest
        outputs:
            releases_created: ${{ steps.release.outputs.releases_created }}
            shacl-rust--release_created: ${{ steps.release.outputs['--release_created'] }}
            shacl-cli--release_created: ${{ steps.release.outputs['crates/shacl-cli--release_created'] }}
            shacl-mcp--release_created: ${{ steps.release.outputs['crates/shacl-mcp--release_created'] }}
            shacl-wasm--release_created: ${{ steps.release.outputs['crates/shacl-wasm--release_created'] }}
        steps:
            - name: Run release-please
              id: release
              uses: googleapis/release-please-action@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  config-file: .github/release-please-config.json
                  manifest-file: .github/.release-please-manifest.json

    publish-crates:
        needs: release-please
        if: ${{ needs.release-please.outputs.releases_created == 'true' }}
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Rust
              uses: actions-rust-lang/setup-rust-toolchain@v1
              with:
                  toolchain: stable

            - name: Publish shacl-rust (main crate)
              if: ${{ needs.release-please.outputs['shacl-rust--release_created'] == 'true' }}
              run: |
                  cd ${{ github.workspace }}
                  cargo publish --package shacl-rust --token ${{ secrets.CARGO_REGISTRY_TOKEN }}

            # Wait for crates.io index to update
            - name: Wait for crates.io index update
              if: ${{ needs.release-please.outputs['shacl-rust--release_created'] == 'true' }}
              run: sleep 45

            - name: Publish shacl-cli
              if: ${{ needs.release-please.outputs['crates/shacl-cli--release_created'] == 'true' }}
              run: cargo publish --package shacl-cli --token ${{ secrets.CARGO_REGISTRY_TOKEN }}

            - name: Publish shacl-mcp
              if: ${{ needs.release-please.outputs['crates/shacl-mcp--release_created'] == 'true' }}
              run: cargo publish --package shacl-mcp --token ${{ secrets.CARGO_REGISTRY_TOKEN }}

            - name: Publish shacl-wasm
              if: ${{ needs.release-please.outputs['crates/shacl-wasm--release_created'] == 'true' }}
              run: cargo publish --package shacl-wasm --token ${{ secrets.CARGO_REGISTRY_TOKEN }}
