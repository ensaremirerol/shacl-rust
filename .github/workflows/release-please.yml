name: Release Please

on:
    push:
        branches:
            - dev
        paths:
            - "crates/**"
            - "src/**"
            - "Cargo.toml"

permissions:
    contents: write
    pull-requests: write

jobs:
    release-please:
        runs-on: ubuntu-latest
        if: github.actor != 'github-actions[bot]'
        outputs:
            releases_created: ${{ steps.release.outputs.releases_created }}

        steps:
            - name: Run release-please
              id: release
              uses: googleapis/release-please-action@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  config-file: .github/release-please-config.json
                  manifest-file: .github/.release-please-manifest.json
                  target-branch: main

    publish-crates:
        needs: release-please
        if: ${{ needs.release-please.outputs.releases_created == 'true' }}
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Rust
              uses: actions-rust-lang/setup-rust-toolchain@v1
              with:
                  toolchain: stable
              if: ${{ needs.release-please.outputs.prs_created == 'true' }}
            - name: Publish shacl-rust (main crate)
              run: |
                  cargo publish --package shacl-rust --token ${{ secrets.CARGO_REGISTRY_TOKEN }} || echo "Already published or failed"

            # Wait for crates.io index to update
            - name: Wait for crates.io index update
              run: sleep 45

            - name: Publish shacl-cli
              run: cargo publish --package shacl-cli --token ${{ secrets.CARGO_REGISTRY_TOKEN }} || echo "Already published or failed"

            - name: Publish shacl-mcp
              run: cargo publish --package shacl-mcp --token ${{ secrets.CARGO_REGISTRY_TOKEN }} || echo "Already published or failed"

            - name: Publish shacl-wasm
              run: cargo publish --package shacl-wasm --token ${{ secrets.CARGO_REGISTRY_TOKEN }} || echo "Already published or failed"
    sync-dev-branch:
        needs: publish-crates
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Sync dev branch with main
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git fetch origin main
                  git checkout dev
                  git merge --ff-only origin/main || git merge origin/main -m "chore: sync dev with main after release"
                  git push origin dev
